支付回调是第三方支付平台发起给我们的请求。

## 📁 支付回调流程详解

### 1. **谁发起回调请求？**

```
用户付款成功 → 支付平台（微信/支付宝） → 我们的后端
      ↑                              ↓
   前端调起支付                    回调通知
```

**回调发起方**：支付宝、微信等第三方支付平台

**回调接收方**：我们的后端服务器

### 2. **完整支付流程**

```
// 1. 前端调起支付
前端 → 调用支付SDK → 调起微信/支付宝APP

// 2. 用户支付
用户在支付APP中完成支付

// 3. 支付平台回调
支付平台（支付宝/微信） → HTTP POST请求 → 我们的回调接口

// 4. 我们处理回调
我们的后端 → 验证签名 → 更新订单状态 → 处理业务逻辑

// 5. 返回结果给支付平台
我们的后端 → 返回 success/failure → 支付平台
```

### 3. **回调时序图**

```
┌─────┐     ┌──────────┐     ┌─────────┐     ┌──────────┐
│ 用户 │     │   前端   │     │   后端   │     │支付平台(微信)│
└──┬──┘     └────┬─────┘     └────┬────┘     └─────┬────┘
   │             │                 │                │
   │ 1.点击支付   │                 │                │
   ├─────────────►                 │                │
   │             │                 │                │
   │             │ 2.请求创建支付  │                │
   │             ├────────────────►│                │
   │             │                 │                │
   │             │    3.返回支付参数 │                │
   │             │◀────────────────┤                │
   │             │                 │                │
   │             │ 4.调起支付SDK    │                │
   │             ├──────────────────────────────────►│
   │             │                 │                │
   │ 5.用户支付   │                 │                │
   ├───────────────────────────────┼───────────────►│
   │             │                 │                │
   │             │                 │     6.支付完成  │
   │             │                 │◀───────────────┤
   │             │                 │                │
   │             │                 │  7.回调通知    │
   │             │                 │◀───────────────┤
   │             │                 │                │
   │             │                 │8.处理回调业务   │
   │             │                 │──┐             │
   │             │                 │  │ 更新订单     │
   │             │                 │◀─┘             │
   │             │                 │                │
   │             │                 │9.返回处理结果  │
   │             │                 ├───────────────►│
   │             │                 │                │
   │ 10.前端轮询  │                 │                │
   ├─────────────►                 │                │
   │             │ 11.查询支付结果 │                │
   │             ├────────────────►│                │
   │             │                 │                │
   │             │ 12.返回支付结果 │                │
   │             │◀────────────────┤                │
   │             │                 │                │
   │ 13.展示结果  │                 │                │
   │◀─────────────┤                 │                │
   │             │                 │                │
```

### 4. **回调处理的关键点**

```
@RestController
@RequestMapping("/api/pay/callback")
public class PaymentCallbackController {
    
    /**
     * 微信支付回调
     * 注意：这是微信主动调我们的接口！
     */
    @PostMapping("/wechat")
    public String wechatCallback(HttpServletRequest request) {
        // 微信服务器POST请求到这个接口
        // 包含：支付结果、签名、订单号等
        // 我们需要：验证签名、处理业务、返回XML结果
    }
    
    /**
     * 支付宝回调
     * 注意：这是支付宝主动调我们的接口！
     */
    @PostMapping("/alipay")
    public String alipayCallback(HttpServletRequest request) {
        // 支付宝服务器POST请求到这个接口
        // 包含：支付结果、签名、订单号等
        // 我们需要：验证签名、处理业务、返回success/failure
    }
}
```

### 5. **为什么需要回调？**

| 回调方              | 原因                                                         | 优势                                                         |
| ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **支付平台 → 我们** | 1. 前端支付结果不可靠 2. 支付结果最终确认权在支付平台 3. 避免轮询开销 4. 保证数据一致性 | 1. 结果准确可靠 2. 实时性高 3. 减少服务器压力 4. 防止用户关闭页面导致结果丢失 |

### 6. **回调 vs 轮询**

```
/**
 * 两种获取支付结果的方案
 */
public class PaymentResultStrategy {
    
    // 方案1：主动轮询（前端主导）
    public void pollingStrategy(String paymentNo) {
        // 前端定时调用后端接口查询
        // 优点：实现简单
        // 缺点：延迟高、服务器压力大
    }
    
    // 方案2：回调通知（支付平台主导）
    public void callbackStrategy(String paymentNo) {
        // 支付平台主动通知我们
        // 优点：实时、准确、可靠
        // 缺点：需要公网可访问的接口
    }
    
    // 实际使用：两者结合
    public void hybridStrategy(String paymentNo) {
        // 1. 前端轮询5-10次（快速响应）
        // 2. 同时等待回调（最终确认）
        // 3. 回调失败时，后端定时任务补偿
    }
}
```

### 7. **回调接口要求**

```
# 回调接口配置要求
回调接口:
  协议: HTTPS (生产环境必须)
  方法: POST
  超时: 5秒内必须响应
  幂等: 必须支持重复回调
  签名: 必须验证签名
  返回格式:
    微信: XML格式
    支付宝: 字符串success/failure
  日志: 必须完整记录
  
# 回调地址配置示例
支付配置:
  微信:
    回调地址: https://api.yourdomain.com/api/pay/callback/wechat
    超时时间: 5秒
    重试次数: 3次
    重试间隔: 2分钟
    
  支付宝:
    回调地址: https://api.yourdomain.com/api/pay/callback/alipay
    超时时间: 5秒
    重试次数: 3次
    重试间隔: 2分钟
```

### 8. **回调处理伪代码**

```
// 支付平台的代码（微信/支付宝）
class PaymentPlatform {
    
    public void notifyMerchant(String paymentNo, boolean success) {
        // 支付平台发起HTTP请求
        String callbackUrl = "https://your-api.com/api/pay/callback";
        Map<String, String> params = buildCallbackParams(paymentNo, success);
        
        // 发送回调请求
        HttpResponse response = httpClient.post(callbackUrl, params);
        
        // 检查响应
        if (!"success".equals(response.getBody())) {
            // 回调失败，2分钟后重试
            scheduleRetry(paymentNo);
        }
    }
}

// 我们的后端代码
@RestController
class OurBackend {
    
    @PostMapping("/callback")
    public String handleCallback(@RequestBody CallbackParams params) {
        // 1. 验证签名
        if (!verifySign(params)) {
            return "failure";  // 告诉支付平台回调失败
        }
        
        // 2. 处理业务
        try {
            processPayment(params);
            return "success";  // 告诉支付平台回调成功
        } catch (Exception e) {
            return "failure";  // 告诉支付平台回调失败
        }
    }
}
```

## 🎯 总结

**关键点**：

1. ✅ **回调是支付平台发起** → 微信/支付宝主动调用我们的接口
2. ✅ **我们需要提供回调地址** → 在支付配置中设置
3. ✅ **我们必须响应成功** → 否则支付平台会重试
4. ✅ **回调必须幂等** → 同个订单可能回调多次
5. ✅ **回调必须验签** → 防止伪造请求
6. ✅ **回调必须快速响应** → 5秒内必须返回

**简单说**：

- **前端轮询**：我们主动问支付平台"支付成功了吗？"
- **支付回调**：支付平台主动告诉我们"支付成功了！"

**实际开发注意事项**：

1. 回调接口必须支持HTTPS
2. 需要配置Nginx/网关支持
3. 要有监控和告警
4. 要有重试和补偿机制
5. 日志要完整记录

这样理解回调流程就清晰了！🎉

## 🎯 回调处理完整流程图

```
┌─────────────────────┐
│   支付平台发起回调    │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│  Controller接收回调  │
│ 1. 解析请求参数      │
│ 2. 验证签名         │
│ 3. 封装为DTO        │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│ Service处理回调逻辑  │
│ 1. 查询订单         │
│ 2. 防重处理         │
│ 3. 金额校验         │
│ 4. 更新订单状态      │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│   处理业务逻辑        │
│ 1. 更新业务状态      │
│ 2. 记录流水         │
│ 3. 发送通知         │
└──────────┬──────────┘
           ↓
┌─────────────────────┐
│ 返回处理结果给支付平台 │
│ 微信: SUCCESS/FAIL   │
│ 支付宝: success/failure│
└─────────────────────┘
```