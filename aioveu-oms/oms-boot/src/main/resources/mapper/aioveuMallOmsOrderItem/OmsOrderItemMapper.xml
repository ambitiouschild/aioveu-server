<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aioveu.oms.aioveu02OrderItem.mapper.OmsOrderItemMapper">

<!--    查询存在N+1查询问题！每次查询订单列表都会为每个订单单独执行一次商品查询，这会导致性能问题。-->
<!--    1. 先查询订单列表（1次查询）-->
<!--    2. 为每个订单单独查询商品（N次查询，N=订单数量）-->
<!--    修改 getOrderItemsByOrderId为批量查询-->
    <!-- 根据订单ID获取订单商品列表 -->
    <select id="getOrderItemsByOrderId" resultType="com.aioveu.oms.aioveu01Order.model.vo.OrderBO$OrderItem">
        SELECT
            id,
            order_id,
            spu_name,
            sku_id,
            sku_sn,
            sku_name,
            pic_url,
            price,
            quantity,
            total_amount
        FROM
            oms_order_item
        WHERE
            order_id=#{orderId}
    </select>

    <!-- 获取订单商品信息分页列表 -->
    <select id="getOmsOrderItemPage" resultType="com.aioveu.oms.aioveu02OrderItem.model.vo.OmsOrderItemVO">
        SELECT
        order_id,
        spu_name,
        sku_id,
        sku_sn,
        sku_name,
        pic_url,
        price,
        quantity,
        total_amount,
        deleted,
        create_time,
        update_time
        FROM
        oms_order_item
        <where>
            <if test="queryParams.spuName != null and queryParams.spuName != ''">
                AND spu_name LIKE CONCAT(#{queryParams.spuName}, '%')
            </if>
            <if test="queryParams.skuSn != null and queryParams.skuSn != ''">
                AND sku_sn LIKE CONCAT(#{queryParams.skuSn}, '%')
            </if>
            <if test="queryParams.skuName != null and queryParams.skuName != ''">
                AND sku_name LIKE CONCAT(#{queryParams.skuName}, '%')
            </if>
            <if test="queryParams.deleted != null">
                AND deleted LIKE CONCAT(#{queryParams.deleted}, '%')
            </if>
        </where>
    </select>

</mapper>
