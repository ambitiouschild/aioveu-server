在Seata的AT（Automatic Transaction）模式中，`undo_log`表是一个核心组件，它通过记录数据修改前后的快照，实现了分布式事务的**最终一致性**。以下是关于该表的详细解析。

### 📊 核心作用与工作机制

`undo_log`表的核心作用是实现**数据回滚**。其工作流程与Seata AT模式的两个阶段紧密相关：

- **第一阶段（业务执行与日志记录）**：当分支事务（RM）执行业务SQL时，Seata代理数据源会：

  1. 生成数据更新前的**前置镜像**。

  2. 执行业务SQL。

  3. 生成数据更新后的**后置镜像**。

  4. 将前后镜像作为回滚信息（`rollback_info`），与全局事务ID（`xid`）、分支事务ID（`branch_id`）等一起，作为一条记录**插入到 `undo_log`表中**。

     **关键点**：业务SQL的执行和`undo_log`记录的插入在**同一个本地事务**中，确保二者同时成功或失败。

- **第二阶段（提交或回滚）**：

  - **全局提交**：事务成功，Seata Server（TC）会异步通知各RM**删除**对应的`undo_log`记录，清理快照。
  - **全局回滚**：事务失败，RM会根据`xid`和`branch_id`从`undo_log`中查找回滚日志，生成并执行反向的补偿SQL（如UPDATE变为反向UPDATE，INSERT变为DELETE），将数据还原至前置镜像的状态。回滚完成后，删除对应的`undo_log`记录。

### 🗂️ 表结构详解

`undo_log`表的标准结构及各字段含义如下：

| 字段名          | 数据类型           | 是否必填      | 描述                                                         |
| --------------- | ------------------ | ------------- | ------------------------------------------------------------ |
| `id`            | `bigint`           | 是 (自增主键) | 表的主键ID。部分建表语句可能省略此字段，使用`xid`和`branch_id`作为联合主键。 |
| `branch_id`     | `bigint`           | 是            | 分支事务的唯一标识。                                         |
| `xid`           | `varchar(100/128)` | 是            | 全局事务的唯一标识。与`branch_id`共同构成唯一索引 `ux_undo_log`，确保一个分支事务只有一条日志。 |
| `context`       | `varchar(128)`     | 是            | 记录上下文信息，如回滚日志的**序列化方式**（如`serializer=jackson`）和**压缩算法**（如`compressorType=zip`）。 |
| `rollback_info` | `longblob`         | 是            | **核心字段**。存储序列化后的回滚数据，包含前后镜像（`beforeImage`和`afterImage`）。 |
| `log_status`    | `int`              | 是            | 日志状态。`0`：正常状态；`1`：全局事务已完成，用于防悬挂（防止第二阶段回滚请求在一阶段日志产生前到达）。 |
| `log_created`   | `datetime`         | 是            | 记录的创建时间。                                             |
| `log_modified`  | `datetime`         | 是            | 记录的最后修改时间。                                         |

### ⚙️ 关键配置项

在客户端（RM）配置中，可以通过以下参数优化`undo_log`表的行为：

| 配置项                           | 描述                   | 默认值     |
| -------------------------------- | ---------------------- | ---------- |
| `client.undo.logTable`           | 自定义`undo_log`表名。 | `undo_log` |
| `client.undo.logSerialization`   | 回滚信息的序列化方式。 | `jackson`  |
| `client.undo.compress.enable`    | 是否开启回滚信息压缩。 | `true`     |
| `client.undo.compress.type`      | 压缩算法。             | `zip`      |
| `client.undo.compress.threshold` | 触发压缩的阈值。       | `64k`      |

### 💡 实践要点与隔离性保证

- **部署要求**：**每个参与全局事务的业务数据库**都必须创建`undo_log`表。
- **隔离性保证**：
  - **写隔离**：通过**全局锁**实现。在本地事务提交前，RM会尝试获取相关数据的全局锁。只有拿到全局锁，才能提交本地事务并写入`undo_log`。这防止了不同全局事务同时修改同一数据，避免了脏写。
  - **读隔离**：AT模式默认的隔离级别是**读未提交**。如果需要**读已提交**，必须在查询SQL中使用`SELECT ... FOR UPDATE`，该语句也会尝试获取全局锁。

### 💎 总结

`undo_log`表是Seata AT模式的基石。它通过记录数据变更的快照，使得在分布式事务回滚时能够进行精准补偿，从而实现了对业务代码无侵入的分布式事务支持。理解其设计原理和配置，对于正确使用和运维Seata至关重要。